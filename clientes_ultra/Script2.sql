SELECT P.PEDI_COD_PEDIDO cod_pedido_ultra, P.PEDV_NUM_DOCUMENTO num_documento, P.PEDI_COD_CLIENTE id_cliente_ultra, -- C.CLII_COD_ECOM id_cliente_ecom,
DIR.DIRC_UBIGEO ubigeo, P.NUMERO_DOC_REPRE doc_representante, CAST(D.DOCD_FECHA_FIN AS DATE) fec_vence, O.OFTI_VELOCIDAD_PROMO ancho_banda,
CASE WHEN LEN(P.PEDV_NUM_DOCUMENTO) = 11 AND LEFT(P.PEDV_NUM_DOCUMENTO, 2) IN ('20', '10') THEN 'RUC' WHEN LEN(P.PEDV_NUM_DOCUMENTO) = 8 THEN 'DNI' ELSE 'CE' END desc_tipo_documento,
CASE WHEN LEN(P.NUMERO_DOC_REPRE) = 11 AND LEFT(P.NUMERO_DOC_REPRE, 2) IN ('20', '10') THEN 'RUC' WHEN LEN(P.NUMERO_DOC_REPRE) = 8 THEN 'DNI' WHEN ISNULL(P.NUMERO_DOC_REPRE, '') = '' THEN '' ELSE 'CE'
END desc_tipo_documento_repre, ISNULL(PRR.NOMBRES_REPRE, '') desc_nombres_representante,
CASE WHEN O.OFTV_NOMBRE IN ('Ultra 600 Mbps (Plan colaborador)', 'Ultra 600Mbps', 'Ultra 600 Mbps', 'Ultra 600Mbps (Plan Colaborador)') THEN 'Ultra 600' ELSE 'ERROR'
END desc_oferta,
CASE WHEN D.DOCC_COD_TIPO_ESTADO = '03' THEN 'Activo' WHEN D.DOCC_COD_TIPO_ESTADO = '07' THEN 'Suspendido' WHEN D.DOCC_COD_TIPO_ESTADO = '06' THEN 'Baja' ELSE 'ERROR' END estado, CAST(D.DOCD_FECHA_BAJA AS DATE) fec_baja,
CASE WHEN D.DOCC_COD_TIPO_ESTADO = '07' THEN CAST(D.DOCD_FECHA_SUSPENSION AS DATE) ELSE NULL END fec_suspension,
'Soles' desc_moneda, DIR.DIRV_NOMBRE desc_direccion, DIR.DIRN_LATITUD desc_latitud, DIR.DIRN_LONGITUD desc_longitud, 
UPPER(UBI1.UBIV_DESCRIPCION) desc_distrito, UPPER(UBI2.UBIV_DESCRIPCION) desc_provincia, UPPER(UBI3.UBIV_DESCRIPCION) desc_region,
CASE WHEN LEN(P.PEDV_NUM_DOCUMENTO) = 11 AND LEFT(P.PEDV_NUM_DOCUMENTO, 2) = '20' THEN CONCAT(
		ISNULL(PR.PEDC_NOMBRES_APELLIDOS, ''), (CASE WHEN LTRIM(RTRIM(ISNULL(PR.PEDV_APE_PATERNO, '.'))) <> '.' THEN CONCAT(' ', PR.PEDV_APE_PATERNO) ELSE '' END), 
		(CASE WHEN LTRIM(RTRIM(ISNULL(PR.PEDV_APE_MATERNO, '.'))) <> '.' THEN CONCAT(' ', PR.PEDV_APE_MATERNO) ELSE '' END) ) ELSE '' END desc_razon_social, 
CASE WHEN LEN(P.PEDV_NUM_DOCUMENTO) = 11 AND LEFT(P.PEDV_NUM_DOCUMENTO, 2) = '20' THEN '' ELSE ISNULL(PR.PEDC_NOMBRES_APELLIDOS, '') END desc_nombres,
CASE WHEN LEN(P.PEDV_NUM_DOCUMENTO) = 11 AND LEFT(P.PEDV_NUM_DOCUMENTO, 2) = '20' THEN '' ELSE ISNULL(PR.PEDV_APE_PATERNO, '') END desc_ape_paterno,
CASE WHEN LEN(P.PEDV_NUM_DOCUMENTO) = 11 AND LEFT(P.PEDV_NUM_DOCUMENTO, 2) = '20' THEN '' ELSE ISNULL(PR.PEDV_APE_MATERNO, '') END desc_ape_materno
, ISNULL(PR.PEDV_CORREO, '') desc_correo, ISNULL(PR.PEDV_CELULAR, '') desc_celular, 
CASE WHEN PR.PEDV_CELULAR <> PR.PEDV_TELEFONO THEN PR.PEDV_TELEFONO ELSE '' END desc_telefono,
CO.CONI_ID_CONTRATO id_contrato_ecom, CLI.CLII_ID_CLIENTE id_cliente_ecom, S.SERI_ID_SERVICIO id_servicio_ecom,
PERI.PERIODO desc_ultimo_periodo
FROM CRM.CRM_PEDIDO P
INNER JOIN CRM.CRM_DIRECCION DIR ON P.PEDI_COD_DIRECCION = DIR.DIRI_COD_DIRECCION
LEFT JOIN CRM.CRM_TIPO T2 ON T2.TIPC_CODIGO = DIR.DIRC_COD_TIPO_NUMERACION AND T2.TIPC_CONCEPTO = '07'
LEFT JOIN CRM.CRM_TIPO T3 ON T3.TIPC_CODIGO = DIR.DIRC_COD_TIPO_NIVEL AND T3.TIPC_CONCEPTO = '08'
LEFT JOIN CRM.CRM_TIPO T4 ON T4.TIPC_CODIGO = DIR.DIRC_COD_TIPO_INMUEBLE AND T4.TIPC_CONCEPTO = '09'
INNER JOIN CRM.CRM_UBIGEO UBI1 ON DIR.DIRC_UBIGEO = UBI1.UBIC_UBIGEO
INNER JOIN CRM.CRM_UBIGEO UBI2 ON CONCAT(LEFT(UBI1.UBIC_UBIGEO, 6), '00') = UBI2.UBIC_UBIGEO
INNER JOIN CRM.CRM_UBIGEO UBI3 ON CONCAT(LEFT(UBI2.UBIC_UBIGEO, 4), '0000') = UBI3.UBIC_UBIGEO
INNER JOIN CRM.CRM_OFERTA O ON P.OFTI_COD_OFERTA = O.OFTI_COD_OFERTA
INNER JOIN CRM.CRM_CLIENTE C ON P.PEDI_COD_CLIENTE = C.CLII_COD_CLIENTE
INNER JOIN [10.1.4.20].[PE_OPTICAL_ADM].ECOM.ECOM_CLIENTE CE ON C.CLII_COD_ECOM = CE.CLII_ID_CLIENTE AND C.CLIV_NUMERO_DOCUMENTO = CE.CLIV_NRO_RUC
LEFT JOIN [10.1.2.39].[PE_WINET_ULTRA_20240208_1141].CRM.CRM_PEDIDO PR ON PR.PEDI_COD_PEDIDO = P.PEDI_COD_PEDIDO AND PR.PEDV_NUM_DOCUMENTO = P.PEDV_NUM_DOCUMENTO
LEFT JOIN [10.1.2.39].[PE_WINET_ULTRA_20240208_1141].CRM.CRM_PEDIDO PRR ON PRR.PEDI_COD_PEDIDO = P.PEDI_COD_PEDIDO AND PRR.PEDV_NUM_DOCUMENTO = P.PEDV_NUM_DOCUMENTO AND PRR.NUMERO_DOC_REPRE = P.NUMERO_DOC_REPRE
INNER JOIN CRM.CRM_DOCUMENTO D ON P.PEDI_COD_PEDIDO = D.DOCI_COD_PEDIDO_REF
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_CONTRATO CO ON D.DOCI_COD_ECOM = CO.CONI_ID_CONTRATO
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_EMPRESA_CLIENTE EC ON  CO.EMCI_ID_EMP_CLI = EC.EMCI_ID_EMP_CLI
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_CLIENTE CLI ON EC.CLII_ID_CLIENTE = CLI.CLII_ID_CLIENTE AND P.PEDV_NUM_DOCUMENTO = CLI.CLIV_NRO_RUC -- AND CLI.CLII_ID_CLIENTE = C.CLII_COD_ECOM
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_SERVICIO S ON CO.CONI_ID_CONTRATO = S.CONI_ID_CONTRATO
LEFT JOIN (
	SELECT CSQ.COMC_COD_ENTIDAD, CDSQ.SERI_ID_SERVICIO, MAX(CSQ.COMV_PERIODO_COMPROBANTE) PERIODO
    FROM [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.COMPROBANTE CSQ
    INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.COMPROBANTE_DET CDSQ ON CSQ.COMC_COD_COMPROBANTE = CDSQ.COMC_COD_COMPROBANTE
    WHERE CSQ.ESTI_ID_ESTADO = 9 AND CSQ.TCOI_ID_TIPOCOMPRO = 6 AND CSQ.COMC_TIPO_OPERACION IN ('A', 'C') AND CSQ.COMC_COD_EMPRESA IN (10, 20)
    GROUP BY CSQ.COMC_COD_ENTIDAD, CDSQ.SERI_ID_SERVICIO
) PERI ON PERI.SERI_ID_SERVICIO = S.SERI_ID_SERVICIO AND PERI.COMC_COD_ENTIDAD = CLI.CLII_ID_CLIENTE
INNER JOIN CRM.CRM_VENTA V ON D.DOCI_COD_DOCUMENTO = V.VTAI_COD_DOCUMENTO
INNER JOIN CRM.CRM_TIPO T1 ON D.DOCC_COD_TIPO_MONEDA = T1.TIPC_CODIGO AND T1.TIPC_CONCEPTO = 28
INNER JOIN CRM.CRM_PROGRAMACION PRO ON D.DOCI_COD_DOCUMENTO = PRO.PRGI_COD_PROGRAMACION
WHERE P.PEDI_COD_PEDIDO IN ( 5007073, 5006988, 5006827, 5006817, 5006575, 5006059, 5006022, 5005630, 5005538, 5005416, 5005389, 5005374, 5004997, 5004946, 5004627, 
5004405, 5004326, 5004269, 5004106, 5004057, 5003868, 5003486, 5003069, 5002931, 5002824, 5002698, 5002641, 5002549, 5002385, 5002314, 5002024, 5001998, 5001896, 
5001844, 5001830, 5001761, 5001721, 5001573, 5001452, 5001444, 5001417, 5001413, 5001369, 5001300, 5001209, 5001059, 5001018, 5000859, 5000730, 5000567, 5000555, 
5000470, 5000429, 5000394, 5000385, 5000351, 5000333, 5000325, 5000297, 5000282, 5000249, 5000248, 5000241, 5000225, 5000214, 5000166, 5000153, 5000114, 5000113, 
5000110, 5000098, 5000097, 5000087, 5000084, 5000067, 5000064, 5000063, 5000061, 5000057, 5000046, 5000044, 5000043, 5000037, 5000036, 5000035, 5000034, 5000030, 
5000026, 5000025, 5000022, 5000008, 5000007);

-- 92

INSERT INTO OPENQUERY([10.1.4.20], 'SELECT * FROM PE_OPTICAL_ADM.dbo.data_raw_ultra_bk2')
SELECT * FROM data_raw_ultra_bk2;

exec sp_columns 'data_raw_ultra_bk2'

select * INTO [10.1.4.20].[PE_OPTICAL_ADM].dbo.[data_raw_ultra_bk] from data_raw_ultra_bk2

SELECT CO.CONI_ID_CONTRATO id_contrato_ecom, CLI.CLII_ID_CLIENTE id_cliente_ecom, S.SERI_ID_SERVICIO id_servicio_ecom
FROM CRM.CRM_PEDIDO P
INNER JOIN CRM.CRM_DOCUMENTO D ON P.PEDI_COD_PEDIDO = D.DOCI_COD_PEDIDO_REF
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_CONTRATO CO ON D.DOCI_COD_ECOM = CO.CONI_ID_CONTRATO
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_EMPRESA_CLIENTE EC ON  CO.EMCI_ID_EMP_CLI = EC.EMCI_ID_EMP_CLI
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_CLIENTE CLI ON EC.CLII_ID_CLIENTE = CLI.CLII_ID_CLIENTE AND P.PEDV_NUM_DOCUMENTO = CLI.CLIV_NRO_RUC
INNER JOIN [10.1.4.20].PE_OPTICAL_ADM_PROD_20241222_071629.ECOM.ECOM_SERVICIO S ON CO.CONI_ID_CONTRATO = S.CONI_ID_CONTRATO
WHERE P.PEDI_COD_PEDIDO IN ( 5007073, 5006988, 5006827, 5006817, 5006575, 5006059, 5006022, 5005630, 5005538, 5005416, 5005389, 5005374, 5004997, 5004946, 5004627, 
5004405, 5004326, 5004269, 5004106, 5004057, 5003868, 5003486, 5003069, 5002931, 5002824, 5002698, 5002641, 5002549, 5002385, 5002314, 5002024, 5001998, 5001896, 
5001844, 5001830, 5001761, 5001721, 5001573, 5001452, 5001444, 5001417, 5001413, 5001369, 5001300, 5001209, 5001059, 5001018, 5000859, 5000730, 5000567, 5000555, 
5000470, 5000429, 5000394, 5000385, 5000351, 5000333, 5000325, 5000297, 5000282, 5000249, 5000248, 5000241, 5000225, 5000214, 5000166, 5000153, 5000114, 5000113, 
5000110, 5000098, 5000097, 5000087, 5000084, 5000067, 5000064, 5000063, 5000061, 5000057, 5000046, 5000044, 5000043, 5000037, 5000036, 5000035, 5000034, 5000030, 
5000026, 5000025, 5000022, 5000008, 5000007);

select * from [10.1.2.39].[PE_WINET_ULTRA_20240208_1141].CRM.CRM_PEDIDO



SELECT * FROM CRM.CRM_DOCUMENTO WHERE DOCI_COD_ECOM = 16488797


SELECT * FROM CRM.CRM_DOCUMENTO WHERE DOCI_COD_ECOM = 18012926

UPDATE CRM.CRM_DOCUMENTO SET DOCI_COD_ECOM = 16488797 WHERE DOCI_COD_DOCUMENTO = 705621

select * from crm.crm_cliente WHERE CLII_COD_ECOM = 961241
-- 961241 -- 20538849970

select * from CRM.CRM_TIPO WHERE TIPC_CONCEPTO = 28 
select * from CRM.CRM_UBIGEO

select VTAC_COD_TIPO_MONEDA from CRM.CRM_VENTA

SELECT * FROM CRM.CRM_DIRECCION
SELECT * FROM CRM.CRM_TIPO WHERE TIPC_CONCEPTO = '07' -- *-- Tipo de Numeración : CRM_DIRECCION.DIRC_COD_TIPO_NUMERACION
SELECT * FROM CRM.CRM_TIPO WHERE TIPC_CONCEPTO = '08' -- *-- Tipo de Nivel CRM_DIRECCION.DIRC_COD_TIPO_NIVEL
SELECT * FROM CRM.CRM_TIPO WHERE TIPC_CONCEPTO = '09' -- *-- Tipo de Inmueble CRM_DIRECCION.DIRC_COD_TIPO_INMUEBLE

SELECT * FROM CRM.CRM_TIPO WHERE TIPV_NOMBRE LIKE '%TIPO_NUME%'

SELECT * FROM [10.1.4.20].[PE_OPTICAL_ADM_PROD_20241222_071629].ECOM.ECOM_CLIENTE WHERE CLII_ID_CLIENTE = 961241 AND CLIV_NRO_RUC = '20538849970'

SELECT * FROM [10.1.4.20].[PE_OPTICAL_ADM_PROD_20241222_071629].ECOM.ECOM_EMPRESA_CLIENTE WHERE EMCI_ID_EMP_CLI = 961241 



SELECT TOP 10 * FROM [10.1.4.20].[PE_OPTICAL_ADM].ECOM.ECOM_CLIENTE ORDER BY 1 DESC






